<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE sqlMap      
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"      
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="User">

	<!-- 获取用户粉丝排行榜 -->
	<resultMap id="fansRankingItem" class="com.melot.kktv.model.FansRankingItem">
		<result property="userId" column="userId" />
		<result property="contribution" column="contribution" />
		<result property="roomSource" column="roomSource" />
	</resultMap>
	
	<!-- 更新快牙用户手机号信息 -->
	<update id="updateKuaiyaUserPhoneNum" parameterClass="java.util.Map">
		update user_account_kuaiya set phonenum = #phoneNum# where userid = #userId# and uuid = #uuid#
	</update>
	
	<select id="getWeeklyFansRanking" resultMap="fansRankingItem" parameterClass="java.util.Map">
		select t3.userId, t3.contribution, 1 as roomSource 
		  	from (select t2.userId, t2.contribution
				  from (select t1.*
				          from (select t.userid, sum(t.amount) AS contribution
				                  from gift_history t
				                 where t.dtime >= trunc(sysdate) - 7
				                   and <![CDATA[t.dtime < trunc(sysdate)]]>
				                   <isEqual property="roomSource" compareValue="14">
			             					and t.roomid = #roomId#
			         			   </isEqual>
                                   <isNotEqual property="roomSource" compareValue="14">
                                            and t.touserid = #roomId#
                                   </isNotEqual>
				                   and not exists(select 1
				                   		  from hist_xman_consume p
				                   		 where t.histid = p.histid
				                   		 and p.dtime >= trunc(sysdate) - 7
				                   		 and <![CDATA[p.dtime < trunc(sysdate)]]>)
				                 group by t.userid
				                 order by 2 desc) t1 where rownum <![CDATA[<]]> 21) t2) t3
			   order by 2 desc
	</select>
	
	<select id="getMonthlyFansRanking" resultMap="fansRankingItem" parameterClass="java.util.Map">
		select t3.userId, t3.contribution, 1 as roomSource 
		 	from (select t2.userId, t2.contribution
			      from (select t1.*
				          from (select t.userid, sum(t.amount) AS contribution
				                  from gift_history t
				                 where t.dtime >= trunc(sysdate) - 30
				                   and <![CDATA[t.dtime < trunc(sysdate)]]>
				                   <isEqual property="roomSource" compareValue="14">
			             					and t.roomid = #roomId#
			         			   </isEqual>
                                   <isNotEqual property="roomSource" compareValue="14">
                                            and t.touserid = #roomId#
                                   </isNotEqual>
				                   and not exists(select 1
				                   		  from hist_xman_consume p
				                   		 where t.histid = p.histid
				                   		 and p.dtime >= trunc(sysdate) - 30
				                   		 and <![CDATA[p.dtime < trunc(sysdate)]]>)
				                 group by t.userid
				                 order by 2 desc) t1 where rownum <![CDATA[<]]> 21) t2)t3
			   order by 2 desc
	</select>

	<!-- 插入用户临时密码表 -->
	<insert id="insertUserTempPassword" parameterClass="java.util.Map">
		insert into temp_user_password(userid, origin_password, record_time) values(#userId#, #password#, #dtime#)
	</insert>
	
</sqlMap>