<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE sqlMap      
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"      
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="Index">

	<!-- 获取活动列表 -->
	<resultMap id="Activity" class="com.melot.kktv.model.Activity">
		<result property="activityId" column="activityid" javaType="java.lang.Integer"
			jdbcType="NUMBER"/>
		<result property="activityTitle" column="acttitle" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<result property="imgURL" column="imgurl" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<result property="activityURL" column="activityurl" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<result property="topURL" column="topurl" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<result property="topMobileURL" column="topmobileurl" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<result property="topMobileURLIOS" column="topmobileurlios" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<result property="sharedText" column="sharedtext" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<result property="sharedImgURL" column="sharedimgurl" javaType="java.lang.String"
			jdbcType="VARCHAR" />
	</resultMap>
	
	<resultMap id="HotActivity" class="com.melot.kktv.model.HotActivity">
		<result property="activityId" column="activityid" javaType="java.lang.Integer"
			jdbcType="NUMBER"/>
		<result property="imgURL" column="imgurl" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<result property="activityURL" column="activityurl" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<result property="isHot" column="ishot" javaType="java.lang.Integer"
			jdbcType="VARCHAR" />
		<result property="activityTitle" column="acttitle" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<result property="topURL" column="topurl" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<result property="topMobileURL" column="topmobileurl" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<result property="topMobileURLIOS" column="topmobileurlios" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<result property="sharedText" column="sharedtext" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<result property="sharedImgURL" column="sharedimgurl" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<result property="startDate" column="startdate" javaType="java.util.Date"
			jdbcType="TIMESTAMP" />
		<result property="endDate" column="enddate" javaType="java.util.Date"
			jdbcType="TIMESTAMP" />
		<result property="dtime" column="dtime" javaType="java.util.Date"
			jdbcType="TIMESTAMP" />
	</resultMap>
	
	<parameterMap id="activityListMap" class="java.util.Map">
		<parameter property="isTop" mode="IN" javaType="java.lang.Integer"
			jdbcType="INTEGER" />
		<parameter property="platform" mode="IN" javaType="java.lang.Integer"
			jdbcType="INTEGER" />
		<parameter property="appId" mode="IN" javaType="java.lang.Integer"
			jdbcType="INTEGER" />
		<parameter property="channel" mode="IN" javaType="java.lang.Integer"
			jdbcType="INTEGER" />
		<parameter property="TagCode" mode="OUT" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<parameter property="activityList" mode="OUT" jdbcType="ORACLECURSOR"
			javaType="java.sql.ResultSet" resultMap="Activity" />
		<parameter property="hotActivityList" mode="OUT" jdbcType="ORACLECURSOR"
			javaType="java.sql.ResultSet" resultMap="HotActivity" />
	</parameterMap>

	<procedure id="getActivityList" parameterMap="activityListMap">
		{call
		p_getActivityList_v3(?,?,?,?,?,?,?)}
	</procedure>

	<!-- 获取活动详细 -->
	<parameterMap class="java.util.Map" id="activityDetail">
		<parameter property="activityId" mode="IN" javaType="java.lang.Integer"
			jdbcType="INTEGER" />
		
		<parameter property="TagCode" mode="OUT" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<parameter property="imgURL" mode="OUT" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<parameter property="activityURL" mode="OUT" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<parameter property="dtime" mode="OUT" javaType="java.util.Date"
			jdbcType="TIMESTAMP" />
		<parameter property="content" mode="OUT" javaType="java.lang.String"
			jdbcType="CLOB" />
		<parameter property="topURL" mode="OUT" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<parameter property="topMobileURL" mode="OUT" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<parameter property="topMobileURLIOS" mode="OUT"
			javaType="java.lang.String" jdbcType="VARCHAR" />
		<parameter property="startDate" mode="OUT" javaType="java.util.Date"
			jdbcType="TIMESTAMP" />
		<parameter property="endDate" mode="OUT" javaType="java.util.Date"
			jdbcType="TIMESTAMP" />
	</parameterMap>
	<procedure id="getActivityDetail" parameterMap="activityDetail">
		{call
		p_getActivityDetail(?,?,?,?,?,?,?,?,?,?,?)}
	</procedure>

	<!-- 获取公告列表 -->
	<resultMap id="Notice" class="com.melot.kktv.model.Notice">
		<result property="noticeId" column="noticeid" />
		<result property="title" column="title" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<result property="noticeURL" column="noticeurl" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<result property="dtime" column="dtime" javaType="java.util.Date"
			jdbcType="TIMESTAMP" />
	</resultMap>

	<parameterMap id="noticeListMap" class="java.util.Map">
		<parameter property="appId" mode="IN" javaType="java.lang.Integer"
			jdbcType="INTEGER" />
		<parameter property="channel" mode="IN" javaType="java.lang.Integer"
			jdbcType="INTEGER" />
		<parameter property="start" mode="IN" javaType="java.lang.Integer"
			jdbcType="INTEGER" />
		<parameter property="offset" mode="IN" javaType="java.lang.Integer"
			jdbcType="INTEGER" />
			
		<parameter property="TagCode" mode="OUT" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<parameter property="noticeTotal" mode="OUT" javaType="java.lang.Integer"
			jdbcType="INTEGER" />
		<parameter property="noticeList" mode="OUT" jdbcType="ORACLECURSOR"
			javaType="java.sql.ResultSet" resultMap="Notice" />
	</parameterMap>

	<procedure id="getNoticeList" parameterMap="noticeListMap">
		{call
		p_getKKgameNoticeList(?,?,?,?,?,?,?)}
	</procedure>

	<!-- 获取公告详细 -->
	<parameterMap class="java.util.Map" id="noticeDetailMap">
		<parameter property="noticeId" mode="IN" javaType="java.lang.Integer"
			jdbcType="INTEGER" />

		<parameter property="TagCode" mode="OUT" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<parameter property="title" mode="OUT" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<parameter property="noticeURL" mode="OUT" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<parameter property="dtime" mode="OUT" javaType="java.util.Date"
			jdbcType="TIMESTAMP" />
		<parameter property="content" mode="OUT" javaType="java.lang.String"
			jdbcType="CLOB" />
	</parameterMap>
	<procedure id="getNoticeDetail" parameterMap="noticeDetailMap">
		{call
		p_getNoticeDetail(?,?,?,?,?,?)}
	</procedure>
	
	<!-- 获取用户一定时间内收到礼物个数 -->
	<select id="getPeriodUserGiftReceiveCount" resultClass="java.lang.Long" parameterClass="java.util.Map">
		select sum(t.giftcount) from gift_history t where
		t.giftid = #giftId#
		<isGreaterThan property="userId" compareValue="0" prepend="and">
			t.touserid = #userId#
		</isGreaterThan>
		and t.dtime >= #startTime#
		and <![CDATA[t.dtime <= #endTime#]]>
    </select>
    
    <!-- 获取一定时间内送出礼物总数和参与投票用户总数 -->
	<resultMap class="java.util.HashMap" id="getPeriodGiftTotalResult">
    	<result property="totalGift" column="totalGift" javaType="java.lang.Long" jdbcType="Number"/>
    	<result property="totalAmount" column="totalAmount" javaType="java.lang.Long" jdbcType="Number"/>
    	<result property="totalUser" column="totalUser" javaType="java.lang.Long" jdbcType="Number"/>
    </resultMap>
    <select id="getPeriodGiftTotal" resultMap="getPeriodGiftTotalResult" parameterClass="java.util.Map">
    	select nvl(sum(t.giftcount), 0) as totalGift, nvl(sum(t.amount), 0) as totalAmount, nvl(count(distinct t.userid), 0) as totalUser
    	from gift_history t where t.giftid in ($giftIds$)
   	 	and t.dtime >= to_date(#startTime#, 'yyyy-mm-dd hh24:mi:ss')
   	 	<isNotNull prepend="and" property="endTime">
   	 		<![CDATA[t.dtime < to_date(#endTime#, 'yyyy-mm-dd hh24:mi:ss')]]>
   	 	</isNotNull>
    </select>
    
</sqlMap>